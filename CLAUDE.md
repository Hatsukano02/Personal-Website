# CLAUDE.md

这个文件为 Claude Code (claude.ai/code)在此代码库中工作时提供指导。

## 项目概述

这是一个个人网站项目，采用全栈架构：

- **前端**: Next.js 15 + TypeScript + Tailwind CSS + GSAP + Framer Motion
- **后端**: Strapi 5.x CMS + PostgreSQL 数据库
- **用途**: 个人作品集网站，展示技术项目、摄影作品、博客文章、音乐和电影收藏

## 开发命令

### 前端 (./frontend/)

- `npm run dev` - 启动开发服务器(带 Turbopack)
- `npm run build` - 构建生产版本
- `npm run start` - 启动生产服务器
- `npm run lint` - 运行 ESLint

### 后端 (./backend/)

- `npm run develop` - 开发模式启动 Strapi
- `npm run build` - 构建管理面板
- `npm run start` - 启动生产服务器
- `strapi console` - 访问 Strapi 控制台

## 架构设计

### 项目结构

```text
PersonalWebsite/
├── frontend/          # Next.js 15 应用 (App Router)
├── backend/           # Strapi CMS
├── deployment/        # 部署配置
├── docs/             # 技术文档和项目快照
└── Project_Management_Doc/  # 开发方案文档
```

### 前端架构

- **框架**: Next.js 15 with App Router
- **样式**: Tailwind CSS + CSS Modules(复杂组件)
- **状态管理**: Zustand(客户端状态) + React Query(服务端状态)
- **动画**: GSAP(滚动触发) + Framer Motion(交互动画)
- **主页分段**: Hero、About、Projects、Photography、Blog、Music、Movies、Media、Links、Contact

### 核心交互特性（2025-08-04 更新）

- **浮动导航栏**:

  - 鼠标位置响应的智能缩放（最大放大 15%）
  - 椭圆形检测区域（550x150px）
  - 余弦函数字体缩放
  - 支持 10 个 section，桌面端显示 5 个
  - 滚轮和键盘导航支持

- **主题切换开关**:
  - 与导航栏一致的鼠标位置响应（最大放大 12%）
  - 椭圆形检测区域（200x120px）
  - 明/暗/自动三种模式
  - localStorage 持久化

### 后端架构

- **CMS**: Strapi 5.x 自托管
- **数据库**: PostgreSQL
- **内容类型**: Blog Post、Project、Photo、Album、Movie、Media、Social Links
- **文件存储**: 本地文件系统 + 图片处理(Sharp)

### 核心技术

- 全栈 TypeScript
- PostgreSQL 数据持久化
- Next/Image + Sharp 图片优化
- 移动端优先的响应式设计
- 代码分割和懒加载性能优化

## 文档维护要求

### 开发方案文档 (Project_Management_Doc/)

当技术栈、开发方向、依赖或环境配置发生变动时，必须及时更新此文件夹中的文档：

- `backend-architecture.md` - 后端架构方案
- `frontend-architecture.md` - 前端架构方案
- `execution-roadmap.md` - 项目执行路线图
- `database-design.md` - 数据库设计方案
- `animation-solution.md` - 动画解决方案
- `rag-chatbot-architecture.md` - RAG聊天机器人架构方案（已冻结）

### 项目快照文档 (docs/)

完成任何修改、重构、删除、新增操作时，必须维护以下文件：

<!--
#### session-handoff.md

- **目的**: 反映项目最新状态的快照文档
- **内容**: 记录关键修改和当前项目状态
- **更新原则**: 重在还原当前状态，不是机械增加记录
- **用途**: 每次 Claude 开启新会话时作为 context 预读取
-->

#### todo.md

- **目的**: 规划后续工作并跨会话监控进度
- **内容**: 专注记录 todo list 的完成状态
- **用途**: 每次 Claude 开启新会话时作为 context 预读取

### CLAUDE.md 动态更新

根据项目需求积极更新此文件，确保：

- 开发命令的准确性
- 架构描述与实际代码同步
- 新增功能和技术栈的及时记录
- 开发流程的优化建议

## 内容管理

Strapi 后端管理的内容类型：

- 博客文章(带标签和分类)
- 技术项目(截图和技术栈)
- 摄影作品集(EXIF 数据)
- 音乐专辑收藏
- 电影/电视剧评价
- 媒体文件(视频、音频)
- 社交媒体链接

每种内容类型支持关系映射、元数据和文件附件，针对网络传输进行优化。

## RAG 聊天机器人架构

### 技术栈

- **后端框架**: FastAPI v0.115.x + Python 3.9+
- **向量数据库**: ChromaDB v0.5.x (2GB RAM 最低要求)
- **LLM**: OpenAI GPT-4.1 mini (1M+ token 上下文窗口)
- **嵌入模型**: OpenAI text-embedding-3-small
- **部署**: Docker 容器化，与 Strapi 共享 VPS

### 开发命令

#### RAG 后端 (./rag-backend/)

- `pip install -r requirements.txt` - 安装依赖
- `uvicorn main:app --reload` - 开发模式启动
- `docker build -t rag-chatbot .` - 构建 Docker 镜像
- `docker run -p 8000:8000 rag-chatbot` - 运行容器

### 核心特性

- **阅后即焚设计**: 对话不持久化，每次会话独立
- **RAG 检索增强**: 基于个人知识库的上下文回答
- **成本优化**: GPT-4.1 mini ($0.40/$1.60 per 1M tokens)
- **限流保护**: 3 queries/min, 5 rounds/session
- **分块策略**: 1500 tokens/chunk 充分利用大上下文窗口

## 开发注意事项

- 项目采用 monorepo 结构，前后端分离
- 所有内容通过 Strapi CMS 管理
- 前端通过 Strapi 的 REST/GraphQL API 获取数据
- 动画性能优化采用硬件加速
- 图片处理包括 WebP/AVIF 生成和多尺寸适配
- 网站设计为 VPS 自托管，使用 Nginx + PM2

## 开发命令快速参考

### 调试和检查

- `npm run lint` - 运行 ESLint 检查
- `npx tsc --noEmit` - TypeScript 类型检查
- `npm run build` - 生产构建测试

## 协作开发模式 (2025-08-07 更新)

### 角色分工

- **Claude**: 负责代码全面排查、错误分析、系统性问题定位、提供技术解决方案
- **用户**: 负责运行测试、提供页面渲染反馈、验证功能效果、手动启动前后端服务

### 开发服务启动方式

**前端启动**：用户手动执行 `npm run dev`，Claude 不执行此命令
**后端启动**：用户手动执行 `npm run develop`，Claude 不执行此命令
**测试协作**：用户在两个终端分别运行前后端服务，便于查看日志和协助调试

### 🔍 系统性问题解决流程

**核心原则：针对单个抽象问题进行完整链路排查，避免反复测试浪费时间**

#### 1. 问题范围界定

明确当前要解决的单个抽象问题（如"主题切换不生效"、"构建失败"等）：

- **问题描述**: 用户反馈的具体现象
- **影响范围**: 确定问题涉及的功能模块
- **优先级判断**: 避免同时处理多个抽象问题造成交叉影响

#### 2. 完整技术链路分析

针对该抽象问题，分析整个相关技术链路：

- **配置文件检查**: 相关的 Tailwind 配置、TypeScript 配置、构建配置
- **代码实现验证**: 组件中实际使用的类名/API 调用
- **依赖关系追踪**: CSS 变量、工具类、导入导出关系
- **构建产物检查**: safelist、CSS 生成、类名匹配

#### 3. 系统性根因定位

找出导致该抽象问题的所有具体 bug：

- **技术栈兼容性**: 相关的版本兼容问题
- **配置一致性**: 所有相关配置文件、CSS 变量、组件使用的一致性
- **构建流程验证**: 确保相关配置正确编译到最终产物

#### 4. 完整问题修复

针对该抽象问题，修复所有相关的具体 bug：

- **配置文件同步更新**: 修复所有相关配置的一致性问题
- **组件代码批量修正**: 修复所有使用相同模式的组件
- **依赖关系完整处理**: 确保修改不会破坏其他功能

#### 5. 单次构建验证

完成该抽象问题的所有修复后，进行一次完整构建测试，用户验证该问题是否彻底解决

### 🚫 严禁的调试方式

- **逐步试错**: 禁止"改一点试一下"的方式
- **假设性修复**: 禁止基于猜测进行修改
- **局部修复**: 禁止只修复表面问题而忽略根本原因
- **规避问题**: 禁止用临时方案绕过技术难题
- **多问题并行**: 禁止同时修复多个抽象问题，避免交叉影响

### 调试流程规范

- **单一问题聚焦** - 一次只解决一个抽象问题，便于 git 管理和问题隔离
- **完整链路分析** - 针对该问题覆盖完整的相关技术链路
- **不使用 `npm run dev`** - 用户会手动启动并提供渲染效果反馈
- **系统性修复** - 发现该问题的所有相关 bug 后统一修复，避免反复测试

### 技术问题解决参考

具体的技术问题解决案例和实现细节记录在：

<!-- - `docs/session-handoff.md` - 当前会话的技术问题和解决方案 -->

- `docs/phase_*_config.md` - 各阶段的详细技术规范
- 代码注释中的问题解决说明

### ✅ 质量标准

- **TypeScript 严格模式** - 必须通过所有类型检查
- **ESLint 零禁用** - 不允许禁用规则来规避问题
- **构建零错误** - 生产构建必须完全成功
- **即时修复** - 发现问题立即深入解决，不允许临时 workaround
- **架构一致性** - 统一的设计模式和代码风格
- **文档同步** - 代码实现与配置文档保持同步

### 🏆 核心排查与修复原则

> **（2025-08-08 更新）本节为所有后端疑难问题排查的最高准则，务必严格遵循。**

#### 1. 依赖链完整性验证

Strapi 5.x 初始化严格按顺序：**Database → Services → Routes → Permissions**。排查时必须逐层验证依赖链，任何一环异常都可能导致上层功能失效。

#### 2. 运行时证据要求

配置正确 ≠ 运行时工作。每项配置都需有**运行时验证**（如日志、接口响应、路由列表等）作为证据，不能仅凭配置文件判断问题已解决。

#### 3. 多层级同步监控

排查时需同时监控 logs、routes、services、permissions 等多层级状态，确保所有环节同步无误，避免只关注单一层面遗漏根本原因。

#### 4. 错误信号重视

日志中的任何 **ERROR** 都可能是关键线索，绝不可忽略。遇到异常日志，必须追溯到根本原因并彻底解决。

#### 5. 操作原则

- **一次解决一个问题**：避免并发修改造成交叉影响，便于问题定位和回溯。
- **从根本原因开始**：优先解决基础配置和依赖问题，再处理上层业务逻辑。
- **验证每个步骤**：每次修复后立即验证该问题是否解决，形成闭环。
- **证据链完整性**：每个“已解决”状态都必须有运行时证据支撑（如日志、接口响应、配置快照等）。
- **问题严谨性**：严禁通过降级、绕过或简化配置等方式规避根本性问题，务必采用官方标准和最佳实践彻底解决。

#### 6. 发现未解决时的处理

如果发现问题没有彻底解决，必须**及时中断汇报**，重新回到根本原因排查，避免表面修复或误判。

---
